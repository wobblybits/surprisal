<html>
  <head>
    <style>
      @font-face {
        font-family: "Portfolio";
        src: url("assets/portfolio.woff") format('woff');
      }
      body {
        display: flex;
        flex-direction: row;
        width: 100%;
      }
      #calculator {
        display: flex;
        border-right: 1px solid black;
        flex-direction: column;
        flex-wrap: wrap;
        width: 50%;
        background: gray;
        height: 100%;
      }
      #display {
        padding: 2em 2em 0;
        height: 34%;
      }
      #display textarea {
        background: #aacc99;
        font-family: "Portfolio", Monospace;
        width: 100%;
        height: 100%;
        padding: 1em;
        outline: none;
        font-size: 16px;
        line-height: 24px;
        border: 2px darkgray inset;
      }
      #display textarea:focus {
        outline: none;
      }
      #buttons {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
        flex-grow: 2;
        padding: 2em;
      }
      #buttons > div {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        flex-grow: 2;
        border: 1px solid white;
        background: plum;
        padding: 4px;
      }
      #buttons > div > div {
        display: flex;
        flex-grow: 2;
        flex-direction: column;
        flex-wrap: wrap;
        width: 48px;
        height: 48px;
        border: 2px outset gray;
        background: pink;
        margin: 2px;
        width: calc(100% - 8px);
      }
      #buttons #translate {
        width: 100%
      }
      #buttons > div > div:hover {
        background: purple;
        border: 2px inset gray;
      }
      #buttons > div > div#submit {
        background: orange;
      }
      #buttons > div > div#submit:hover {
        background: red;
      }
      #keyboard {
        border-left: 2px solid black;
        width: 50%;
        position: relative;
      }
      #keyboard > div {
        position: absolute;
        left: 0;
        text-align: right;
        padding-right: 2em;
        align-content: center;
      }
      #keyboard .white-key:hover, #keyboard .white-key.highlight {
        background: pink;
      }
      #keyboard .black-key:hover, #keyboard .black-key.highlight {
        background: purple;
      }
      #keyboard .white-key {
        background: white;
        border: 2px solid black;
        border-left: none;
        height: 6.5%;
        width: calc(100% - 2em); /* subtract padding*/
      }
      #keyboard .black-key {
        background: black;
        width: 50%;
        height: 6%;
        z-index: 99;
        border: 2px solid white;
        border-left: none;
        left: 0px;
        color: white;
      }
    </style>
    <script src="https://unpkg.com/tone"></script>
    <script>
      window.onload = () => {
        
        const synth = new Tone.Synth().toDestination();
        let currentVector = [1,2,3,4,5,6,7,8,9,10];
        Tone.Transport.start(0);

        
        const notes = ["A", "Bb", "B", "C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab"];
        
        function fetchFromBackend(text) {
            const hello = fetch(`/process/?text=${text}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    },
                body: JSON.stringify({text: text})
            })
                .then(response => response.json())
                .then(data => {
                  // document.getElementById("result").innerHTML += JSON.stringify(data) + "<br>";
                    playMelody(data);
                });
        }
        // fetchFromBackend("Hello back there!");


        function playVector(vector) {
            console.log(vector);
            const notes = vector.map(d => Tone.Frequency("C3").transpose(Math.round(d)));
            console.log(notes);
            var seq = new Tone.Sequence(function(time, note){
                synth.triggerAttackRelease(note, "8n", time);
            }, notes, "4n");
            seq.loop = false;
            seq.start(0);
            Tone.start();
        }
        
        function convertSharpToFlat(note) {
          if (note.indexOf("#") == 1) {
            return notes[notes.indexOf(note[0])+1] + note[2];
          }
          return note;
        }

        async function playMelody(data) {
            await Tone.start();
            let surprisals = data.surprisals;
            let pitches = data.scale_pitches;
            let durations = data.lengths;
            let volumes = data.frequencies_inverted;
            let notes = pitches.map(d => Tone.Frequency("C3").transpose(Math.round(d)))
            let delay = Tone.now();
            let offset = delay;
            let timeouts = []
            for(let i = 0; i < surprisals.length; i++) {
                timeouts.push(delay);
                durations[i] /= 8;
                let env = new Tone.Envelope({
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.1,
                    release: durations[i],
                }).toDestination();
                synth.volume.value = volumes[i] / 2;
                synth.triggerAttackRelease(notes[i], durations[i], delay);  
                window.setTimeout(() => {
                  console.log(notes[i].toNote(), convertSharpToFlat(notes[i].toNote()), "start", Tone.Time(durations[i]).toSeconds() * 1000, Tone.Time(timeouts[i]).toSeconds() * 1000); 
                  const key = document.getElementById(convertSharpToFlat(notes[i].toNote()));
                  key.classList.add("highlight");
                  window.setTimeout(() => {
                    console.log(key, notes[i].toNote(), "end");
  
                    key.classList.remove("highlight");
                  }, Tone.Time(durations[i]).toSeconds() * 1000);
                }, (Tone.Time(timeouts[i]).toSeconds() - offset) * 1000);
                delay += durations[i];
            }
        }   
        
        const instruments = ["piano", "theramin", "harp", "flute"];
        const scales = ["major", "minor", "pentatonic", "chromatic", "continuous"];
        const models = ["gpt2", "gpt3", "gpt4"];
        
        const instrument_container = document.getElementById("instruments");
        
        for (i in instruments) {
          const button = document.createElement("div");
          button.id = instruments[i];
          button.innerHTML = instruments[i];
          instrument_container.appendChild(button);
        }
        
        const scales_container = document.getElementById("scales");
        for (i in scales) {
          const button = document.createElement("div");
          button.id = scales[i];
          button.innerHTML = scales[i];
          scales_container.appendChild(button);
        }
        
        const models_container = document.getElementById("models");
        for (i in models) {
          const button = document.createElement("div");
          button.id = models[i];
          button.innerHTML = models[i];
          models_container.appendChild(button);
        }
        
        let startingNote = "C";
        let startingPitch = notes.indexOf(startingNote);
        let startingOctave = 3;
        
        const piano_container = document.getElementById("keyboard");
        let spacing = 0;
        const numOctaves = 2;
        const numKeysPastOctave = 0;
        
        for (var i = 0; i < numOctaves*12 + numKeysPastOctave; i++) {
          const key = document.createElement("div");
          const note = notes[(i+startingPitch) % notes.length];
          key.id = note + (startingOctave + Math.floor(i/12));
          if (note.length > 1) {
            key.style.bottom = (100*(spacing-.5)/(numOctaves * 7 + numKeysPastOctave)) + "%";
            key.classList.add("black-key");
          }
          else {
            key.style.bottom = (100*spacing/(numOctaves * 7 + numKeysPastOctave)) + "%";
            key.classList.add("white-key");
            spacing++;
          }
          key.innerHTML = key.id;
          piano_container.appendChild(key);
        }
        
        const submitButton = document.getElementById("submit");
        submitButton.onclick = (e) => {
          const text = document.getElementById("user-input").value;
          fetchFromBackend(text);
        }
      }  
    </script>
  </head>
  <body>
    <div id="calculator">
      <div id="display">
        <textarea id="user-input" placeholder="Type something"></textarea>
      </div>
      <div id="buttons">
        <div id="scales">
        
        </div>
        <div id="instruments">
        
        </div>
        <div id="models">
        
        </div>
        <div id="translate">
          <div id="submit">Compose</div>
        </div>
      </div>
    </div>
    <div id="keyboard">
      
    </div>
  </body>
</html>